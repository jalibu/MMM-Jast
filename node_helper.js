/*! *****************************************************************************
  mmm-jast
  Version 2.10.3

  A minimalistic stock ticker based on Yahoo's finance API for the MagicMirrorÂ² platform.
  Please submit bugs at https://github.com/jalibu/MMM-Jast/issues

  (c) Jan.Litzenburger@gmail.com
  Licence: MIT

  This file is auto-generated. Do not edit.
***************************************************************************** */
"use strict";var e=require("node_helper"),r=require("logger"),t=require("yahoo-finance2");function a(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var a=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,a.get?a:{enumerable:!0,get:function(){return e[t]}})}}),r.default=e,Object.freeze(r)}var s=a(e),o=a(r),c=a(t);const i="default"in c?c.default:c,n={async requestStocks(e){const r=new i({suppressNotices:["yahooSurvey"]}),t=[],a=[];for(const t of e.stocks)a.push(r.quoteSummary(t.symbol,{modules:["price"]}));const s=await Promise.all(a.map(e=>e.catch(e=>e)));for(const[r,a]of s.entries())if(a instanceof Error)o.warn(`API request for ${e.stocks[r].symbol} failed:`,a.message);else if(a.price){const s={symbol:e.stocks[r].symbol,name:e.stocks[r].name,quantity:e.stocks[r].quantity,hidden:e.stocks[r].hidden,purchasePrice:e.stocks[r].purchasePrice};if("GBp"===a.price.currency&&(a.price.regularMarketPrice/=100,a.price.regularMarketChange/=100,a.price.currency="GBP"),e.maxChangeAge>0){const r=(new Date).getTime()-e.maxChangeAge;try{r>Date.parse(a.price.regularMarketTime)&&(a.price.regularMarketPreviousClose=a.price?.regularMarketPrice,a.price.regularMarketChange=0,a.price.regularMarketChangePercent=0)}catch(e){o.warn("Could not parse lastChange date",e)}}t.push({price:a.price,meta:s})}else o.warn(`Response for ${e.stocks[r].symbol} does not satisfy expected payload.`);return t}},l=["regularMarketChange","regularMarketChangePercent","regularMarketPrice","currency","longName","regularMarketPreviousClose"];module.exports=s.create({start(){o.log(`${this.name} helper method started...`)},async socketNotificationReceived(e,r){if(e.includes("JAST_STOCKS_REQUEST")){const t=e.substring(20);let a=await n.requestStocks(r);a=a.filter(e=>l.every(r=>!!Object.prototype.hasOwnProperty.call(e.price,r)||(o.warn(`Skipped symbol '${e.meta.symbol}' as it's response did not have required property '${r}'. This is usually the case when a symbol is misspelled`),!1)));const s={lastUpdate:Date.now(),stocks:a};this.sendSocketNotification(`JAST_STOCKS_RESPONSE-${t}`,s)}else o.warn(`${e} is invalid notification`)}});
